\section{Метод решения}

Алгоритм решения задачи:

\begin{enumerate}
\item Пользователь в консоль родительского процесса вводит имена файлов, которые будет использовано для открытия (создания) файлов с таким именем для child1 и child2 соответственно.

\item Создается объект класса Parent, так называемый ``родитель''.

\item Родительский процесс создает два канала (pipe) для передачи данных между родительским и дочерними процессами. 
Затем делает первый fork для создания дочернего процеса. Первый дочерний процесс закрывает соответсвующий канал для записи, ``перенаправляет'' второй ``конец'' канала для чтения на стандартный ввод, закрывает второй ``конец'' канала. 
Дочерний процесс пытается запустить бинарный файл для дочернего процесса, если не получилось --- завершается. Аналогично для второго дочернего процесса.

\item Родительский процесс закрывает ``концы'' каналов для чтения и отправляет имена файлов для их открытия (создания) дочерними процессами.

\item Каждый из дочерних процессов пытается открыть (создать) указанный файл в спец. директории, если не получилось --- процесс завершается.

\item Родительский процесс проверяет ``жизнидеятельность'' процессов, если любой из них уже завершен, то программа прекращает работу со статусом ошибки, 
затем считывает пользовательский ввод и отправляет дочернему процессу через pipe по правилу фильтрации.

\item Дочерний процесс инвертирует строку и записывает её в соответствующий файл.

\item По команде ``exit'' или ``quit'' родитель останавливает дочерние процессы и программа завершается.
\end{enumerate}

\vspace{10\baselineskip}

Архитектура программы:

\dirtree{%
.1 lab1/. 
.2 bin/. 
.2 child.cpp.
.2 build/.
.2 include/.
.3 child.h.
.3 exceptions.h.
.3 os.h.
.3 parent.h.
.2 src/.
.3 child.cpp.
.3 os.cpp.
.3 parent.cpp.
.2 testfiles/.
.2 main.cpp.
}

Ссылки:

\begin{itemize}
\item \url{https://pubs.opengroup.org/onlinepubs/009696799/functions/write.html}
\item \url{https://pubs.opengroup.org/onlinepubs/009696799/functions/execl.html}
\item \url{https://pubs.opengroup.org/onlinepubs/009696799/functions/getppid.html}
\item \url{https://pubs.opengroup.org/onlinepubs/009696799/functions/getpid.html}
\item \url{https://pubs.opengroup.org/onlinepubs/009696799/functions/waitpid.html}
\item \url{https://pubs.opengroup.org/onlinepubs/009696799/functions/sleep.html}
\item \url{https://pubs.opengroup.org/onlinepubs/009696799/functions/exit.html}
\item \url{https://pubs.opengroup.org/onlinepubs/009696799/functions/kill.html}
\item \url{https://pubs.opengroup.org/onlinepubs/009696799/functions/dup2.html}
\item \url{https://pubs.opengroup.org/onlinepubs/009696799/functions/pipe.html}
\item \url{https://pubs.opengroup.org/onlinepubs/009696799/functions/fork.html}
\item \url{https://pubs.opengroup.org/onlinepubs/009696799/functions/close.html}
\end{itemize}


\section{Описание программы}

\texttt{main.cpp} --- точка входа в программу, создается объект класса Parent, обрабатываются исключения.
\texttt{bin/child.cpp} --- точка входа в программу для дочернего процесса, создается объект класса Child.

\texttt{exceptions.h} --- объявление необходимых исключений.
\begin{itemize}
\item \texttt{CreatePipeException} --- ошибка создания каналов, программа завершается.
\item \texttt{ChildProcessEndException} --- ошибка внезапного завершения любого из дочерних процессов, программа завершается.
\end{itemize}

\texttt{os.h} --- объявление функций управления процессами ОС. \\ 
\texttt{src/os.cpp} --- реализация.\\
Основные функции:
\begin{itemize}
\item \texttt{int CreatePipe(int pipefd[2]);} --- создание канала. Используется системный вызов \texttt{pipe()}.
\item \texttt{pid\_t Fork();} --- создание клона текущего процесса. Используется системный вызов \texttt{fork()}.
\item \texttt{int Dup2(int fd1, int fd2);} --- ``перенаправление'' файлового дескриптора. Используется системный вызов \texttt{dup2()}.
\item \texttt{int CloseFd(int fd);} --- закрытие файлового дескриптора. Используется системный вызов \texttt{close()}.
\item \texttt{int Exec(const char* processPath, const char* processName);} --- запуск исполняемого файла процессом. Используется системный вызов \texttt{execl()}.
\item \texttt{int KillProcess(pid\_t pid);} --- завершение процесса по pid. Используется системный вызов \texttt{kill()}.
\item \texttt{ssize\_t WriteStr(int fd, const char* buf, size\_t bytes);} --- запись в канал. Используется системный вызов \texttt{write()}.
\item \texttt{pid\_t GetPid();} --- получение pid текущего процесса. Используется системный вызов \texttt{getpid()}.
\item \texttt{pid\_t GetPPid();} --- получение pid родительского процесса. Используется системный вызов \texttt{getppid()}.
\item \texttt{bool IsAliveProcess(pid\_t pid);} --- проверка ``жизнидеятельности'' процесса. Используется системный вызов \texttt{waitpid()} с макросом \texttt{WNOHANG}.
\item \texttt{void Exit(int status);} --- завершение текущего процесса. Используется системный вызов: \texttt{\_exit()}.
\item \texttt{unsigned int Sleep(unsigned int);} --- ожидание. Используется системный вызов: \texttt{sleep()}
\end{itemize}

\vspace{2\baselineskip}


\texttt{child.h} --- объявление класса Child. \\
\texttt{src/child.cpp} --- реализация.\\
Поля класса:
\begin{itemize}
\item \texttt{std::string filename;}  --- название файла для открытия (создания).
\item \texttt{std::ofstream file;}  --- поток для записи в файлы.
\item \texttt{pid\_t pid;}  --- pid процесса.
\end{itemize}
Основные функции \texttt{(методы)}:
\begin{itemize}
\item \texttt{void Work();} --- получает из канала строки, инвертирует их и записывает в файл.
\end{itemize}

\vspace{2\baselineskip}


\texttt{parent.h} --- объявление класса Parent.\\
\texttt{src/parent.cpp} --- реализация.\\
Поля класса:
\begin{itemize}
\item \texttt{std::random\_device rd;}  --- генератор случайных чисел.
\item \texttt{int pipe1[2];}  --- канал для 1 дочернего процесса.
\item \texttt{int pipe2[2];}  --- канал для 2 дочернего процесса.
\item \texttt{pid\_t child1;}  --- pid 1 дочернего процесса.
\item \texttt{pid\_t child2;}  --- pid 2 дочернего процесса.
\end{itemize}
Основные функции \texttt{(методы)}:
\begin{itemize}
\item \texttt{void CreateChildProcesses(std::string filename1, std::string filename2);} --- Создает 2 дочерних процесса и запускает запускает бинарный файл для дочернего процесса, при ошибке дочерний процесс завершается.
\item \texttt{void Work();} --- Получает пользовательский ввод и записывает в один из каналов для дочерних процессов по правилу фильтрации.
\item \texttt{void EndChildren();} --- Завершает дочерние процессы.
\end{itemize} 